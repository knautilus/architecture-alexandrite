## Мотивация

Текущие данные из используемого в системе сервиса Яндекс Метрика охватывают только веб-сайт. С тех пор, как бизнес начал предоставлять оформление заказов через API, этих данных стало недостаточно для полноценного мониторинга всей системы.

Без полного мониторинга мы не сможем оперативно выявлять узкие места, такие как перегрузка MES API или задержки в очередях сообщений, что приведет к росту числа просроченных заказов и потере клиентов.

Внедрение мониторинга позволит видеть текущее состояние системы, быстро реагировать на проблемы, принимать обоснованные решения по оптимизации инфраструктуры и масштабированию сервисов.

Также мониторинг позволит отслеживать бизнес-метрики: DAU — количество уникальных пользователей за день, Retention — возвращаемость пользователей.

## Выбор подхода к мониторингу

Для API (Shop API, CRM API, MES API) будет использована методика RED (Requests Rate, Errors, Duration), чтобы видеть скорость обработки запросов, ошибки и задержки.

Для БД и RabbitMQ будет использована методика USE (Utilization, Saturation, Errors), чтобы отслеживать использование ресурсов.

## Выбор метрик

### RabbitMQ

- Number of dead-letter-exchange letters in RabbitMQ. Показывает количество ошибок в обработке сообщений. Ярлык: имя очереди

- Number of message in flight in RabbitMQ. Если растет количество, значит система не справляется с обработкой сообщений, MES не успевает обработать заказы. Ярлык: имя очереди

### Все API (Shop, CRM, MES)

- Number of requests (RPS). Для оценки нагрузки на сервисы. Ярлык: http-метод и endpoint

- Response time (latency). Для оценки задержки ответов. Ярлык: http-метод и endpoint

- Number of HTTP 500. Для анализа количества ошибок. Ярлык: http-метод и endpoint

- CPU % и Memory Utilization. Для определения загруженности виртуальных машин, для автоматического масштабирования. Ярлык: id инстанса приложения

### Shop DB и MES DB

- Memory Utilization. Рост значения может показать необходимость оптимизации тяжёлых запросов, нехватку ресурсов, необходимость построения индексов

- Size of DB instance. Данные для прогнозирования роста БД и таблиц, планирования увелечения размеров БД и настройки шардирования

### Обработка заказов

- Кол-во заказов в статусах старше 5 дней. Для отслеживания застревающих заказов. Ярлык: id заказа и статус

- Время обработки в статусах. Обнаруживает узкие места в цепочке обработки заказов. Ярлык: id заказа и статус

###  Хранилище S3

- Size of S3 storage. Для планирования затрат на хранение, оптимизацию

## План действий

- Создать инстанс Prometheus как time-series базы для хранения метрик.
- Установить Grafana для визуализации метрик.
- Интеграция сбора метрик в каждый сервис: CRM (Java Spring Boot), MES (C#), RabbitMQ.
- Создать дашборды: для API, для RabbitMQ, для бизнес-процессов (custom дашборд с информацией по заказам - кол-во заказов в каждом статусе и время обработки).
- Настроить алертинг: срабатывание на высокое количество ответов с кодом 500, низкое пространство на диске, высокую загрузку CPU и др.