## Анализ текущей системы

В данный момент источником проблем является система MES и ее интеграции с другими подсистемами. Добавив трейсинг, можно увидеть проблемы с жизненным циклом заказа.

### Трейсингом необходимо покрыть следующие ключевые компоненты:

1. MES (Manufacturing Execution System) - сервис для расчета стоимости и обработки заказов. Возможные проблемы: задержки в расчете стоимости, потеря или зависание заказов.
2. CRM (Customer Relationship Management) - управляет взаимодействием с клиентами и заказами. Возможные проблемы: зависание заказов в процессе обработки или потери сообщений при интеграции.
3. Shop - сервис для формирования заказов от клиентов. Возможные проблемы: потеря заказов при взаимодействии с БД.
4. RabbitMQ (брокер сообщений) - связывает MES и CRM, обеспечивая передачу сообщений между ними. Возможные проблемы: потеря или дублирование сообщений, задержки в доставке.

### В трейсинг должны попадать следующие данные:

1. Уникальный идентификатор заказа - для отслеживания конкретного заказа через всю систему.
2. Service_name - для определения в каком сервисе произошло событие.
3. Временные метки (timestamps) - для фиксации времени начала и окончания обработки на каждом этапе.
4. Статус заказа
5. Коды ошибок и исключения - подробная информация о возникающих ошибках

## Мотивация

Трейсинг упростит разработчикам дебаг сервисов. Это позволит уменьшить Time To Market и ускорить разработку.
Трейсинг позволит получить полную картину прохождения запроса через все сервисы и очереди, в том числе поможет отследить потерянные и "сломанные" заказы. Обнаружение таких заказов позволит улучшить пользовательский опыт.
С помощью трейсинга можно будет обнаружить узкие места сервисов и исправить их. Таким образом можно улучшить большое количество технических метрик - нагрузку, RPS, количество ошибок и т.д.
Внедрение трейсинга повлияет на бизнес-метрики: среднее время обработки заказа, процент просроченных заказов, удовлетворенность клиентов.

## Предлагаемое решение

Трейсинг предлагается построить на основе OpenTelemetry - наиболее популярной платформы для трассировки, и Jaeger - системы хранения и визуализации трейсинга.

1. Развернуть сервис Jaeger-UI, Jaeger-коллектор, Jaeger-агент, хранилище данных телеметрии.
2. В программный код ключевых сервисов (онлайн-магазин, MES, CRM) внедрить библиотеки OpenTelemetry для сбора трейсинг-данных. Настроить отправку трейсов в Jaeger.

[Схема](jewerly_c4_model.drawio)

## Компромиссы

1. Внедрение трейсинга добавляет небольшую задержку на каждый вызов и требует дополнительных ресурсов CPU и памяти в сервисах, а также сетевого трафика
2. MES - сторонний сервис. Потребуется больше времени на внедрение трейсинга. Могут возникнуть проблемы, если сервис написан на старой версии .NET Framework
3. Трейсы с включенными логами и полными payload генерируют огромные объемы данных. Хранение их всех в течение длительного времени может дорого обойтись

## Аспекты безопасности

1. Внедрение аутентификации — зайти в систему смогут только сотрудники компании с актуальной учетной записью и ролью "Поддержка" из внутренней сети компании
2. Для удаленного доступа к трейсам должен использоваться VPN
3. Проконтролировать, чтобы не происходило логирование конфиденциальных данных
4. Настройка сроков хранения данных