## Анализ текущей системы

Требуется сбор логов из систем: CRM API, MES API, Shop API т.к. эти системы влияют на обработку заказов.

### Список необходимых логов на уровне INFO

- Создание заказа: время, order_id, user_id, source (MES API или Shop API), информация о 3D-файле.
- Изменение статуса заказа: время, order_id, from_status, to_status, user_id.
- Загрузка 3D-файла в S3: время, file_id, order_id, size, статус (success или failure).
- Отправка/получение сообщения в RabbitMQ: время, message_id, queue_name, order_id, event_type (new_order или status_change).
- Расчёт стоимости в MES API: время начала, время окончания, order_id, информация о 3D-файле, calculated_price.
- Запрос к дашборду MES: время, user_id, filter_params, loaded_orders_count.
- Подтверждение заказа в CRM: время, order_id, user_id.

### Другие уровни логирования:

- WARN: для подозрительных действий, например, повторная отправка сообщения
- ERROR: для исключений
- FATAL: для критичных ошибок, например, ошибок подключения к бд

## Мотивация

Повышение наблюдаемости системы за счет внедрения логирования приведет к улучшению качества релизов, сокращению времени на поддержку и разбор инцидентов. А это в свою очередь приведет к снижению финансовых потерь, повышению удовлетворенности клиентов, увеличению конверсии и общей эффективности бизнеса.

Очередность внедрения логирования и трейсинга:
1. MES API и CRM API - центральные компоненты для расчета стоимости и управления заказами, после открытия MES API нагрузка на него возросла.
2. Shop API - создание заказов клиентов.

## Предлагаемое решение

### Используемые технологии

ELK-стек (Elasticsearch, Logstash, Kibana) для сбора, обработки и визуализации логов

### Доработки в сервисах

- Устанавливаем единый формат для логов
- В MES API, CRM API и Shop API интегрируем библиотеки для отправки логов в Logstash (например, NLog для .NET)
- Реализуем отправку логов, перечисленных в разделе "Анализ текущей системы"

![Схема](jewerly_c4_model.png)

### Политика безопасности

- Доступ в Kibana осуществляется только из внутренней сети компании или через VPN удаленно
- Пользователям с ролью Devops предоставляется полный доступ к логам, пользователям с ролью QA и Developer - доступ на чтение
- Конфиденциальные данные не логируются

### Политика хранения

- Изначально предлагается хранить логи 3 месяца, т.к. предположительно столько времени сейчас уходит на "застревающие" заказы. Затем, когда проблема с застреванием будет решена, скорректировать срок хранения в меньшую сторону.
- Создать по индексу на каждый сервис. Например, shop-api-logs, crm-api-logs
- Настроить мониторинг использования дискового пространства и производительности Elasticsearch

## Система анализа логов

Настроить оповещения при следующих событиях:
- Резкий рост ошибок 5xx (> 10% от числа запросов)
- Большая задержка расчета стоимости (> 30 минут)
- Резкий рост количества новых заказов (> 100 за секунду) - возможно, DDOS?